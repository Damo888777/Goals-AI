{"version":3,"file":"withWidgetXCode.js","sourceRoot":"","sources":["../../src/ios/withWidgetXCode.ts"],"names":[],"mappings":"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","sourcesContent":["import { ConfigPlugin, withXcodeProject } from \"@expo/config-plugins\";\nimport fs from \"fs-extra\";\nimport path from \"path\";\n\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst xcode = require(\"xcode\");\n\ninterface WithWidgetProps {\n  appGroupId?: string;\n}\n\nconst EXTENSION_TARGET_NAME = \"widget\";\nconst TOP_LEVEL_FILES = [\"widget.swift\", \"SharedDataManager.swift\", \"TaskIntents.swift\", \"Assets.xcassets\", \"Info.plist\"];\n\nconst BUILD_CONFIGURATION_SETTINGS = {\n  ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME: \"AccentColor\",\n  ASSETCATALOG_COMPILER_WIDGET_BACKGROUND_COLOR_NAME: \"WidgetBackground\", \n  CLANG_ANALYZER_NONNULL: \"YES\",\n  CLANG_ANALYZER_NUMBER_OBJECT_CONVERSION: \"YES_AGGRESSIVE\",\n  CLANG_CXX_LANGUAGE_STANDARD: '\"gnu++17\"',\n  CLANG_ENABLE_OBJC_WEAK: \"YES\",\n  CLANG_WARN_DOCUMENTATION_COMMENTS: \"YES\",\n  CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER: \"YES\",\n  CLANG_WARN_UNGUARDED_AVAILABILITY: \"YES_AGGRESSIVE\",\n  CODE_SIGN_STYLE: \"Automatic\",\n  CURRENT_PROJECT_VERSION: \"1\",\n  DEBUG_INFORMATION_FORMAT: \"dwarf\",\n  GCC_C_LANGUAGE_STANDARD: \"gnu11\",\n  GENERATE_INFOPLIST_FILE: \"YES\",\n  INFOPLIST_FILE: \"widget/Info.plist\",\n  INFOPLIST_KEY_CFBundleDisplayName: \"widget\",\n  INFOPLIST_KEY_NSHumanReadableCopyright: '\"\"',\n  IPHONEOS_DEPLOYMENT_TARGET: \"17.0\",\n  LD_RUNPATH_SEARCH_PATHS: '\"$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks\"',\n  MARKETING_VERSION: \"1.0\",\n  MTL_ENABLE_DEBUG_INFO: \"INCLUDE_SOURCE\",\n  MTL_FAST_MATH: \"YES\",\n  PRODUCT_NAME: '\"$(TARGET_NAME)\"',\n  SKIP_INSTALL: \"YES\",\n  SWIFT_ACTIVE_COMPILATION_CONDITIONS: \"DEBUG\",\n  SWIFT_EMIT_LOC_STRINGS: \"YES\",\n  SWIFT_OPTIMIZATION_LEVEL: \"-Onone\",\n  SWIFT_VERSION: \"5.0\",\n  TARGETED_DEVICE_FAMILY: '\"1,2\"',\n  CODE_SIGN_ENTITLEMENTS: \"widget/widget.entitlements\",\n};\n\nexport const withWidgetXCode: ConfigPlugin<WithWidgetProps> = (\n  config,\n  options: WithWidgetProps = {}\n) => {\n  return withXcodeProject(config, async (newConfig) => {\n    try {\n      const projectName = newConfig.modRequest.projectName!;\n      const projectPath = newConfig.modRequest.projectRoot;\n      const platformProjectPath = newConfig.modRequest.platformProjectRoot;\n      const bundleIdentifier = `${config.ios!.bundleIdentifier!}.${EXTENSION_TARGET_NAME}`;\n      \n      // Copy widget files\n      const sourcePath = path.join(projectPath, \"widget\", \"ios\", \"widget\");\n      const widgetPath = path.join(platformProjectPath, EXTENSION_TARGET_NAME);\n      fs.copySync(sourcePath, widgetPath, { overwrite: true });\n      \n      // Update Xcode project\n      const projPath = path.join(platformProjectPath, `${projectName}.xcodeproj`, \"project.pbxproj\");\n      await updateXCodeProj(projPath, bundleIdentifier, (config.ios as any)?.developmentTeam || \"\");\n      \n      console.log(\"[withWidgetXCode] Widget target dependency added to main target.\");\n      return newConfig;\n    } catch (error) {\n      console.error(\"[withWidgetXCode] Error:\", error);\n      throw error;\n    }\n  });\n};\n\nasync function updateXCodeProj(\n  projPath: string,\n  widgetBundleId: string,\n  developmentTeamId: string,\n) {\n  const xcodeProject = xcode.project(projPath);\n\n  xcodeProject.parse(() => {\n    // Add PBX Group for widget files\n    const pbxGroup = xcodeProject.addPbxGroup(\n      TOP_LEVEL_FILES,\n      EXTENSION_TARGET_NAME,\n      EXTENSION_TARGET_NAME,\n    );\n\n    // Add the new PBXGroup to the top level group\n    const groups = xcodeProject.hash.project.objects.PBXGroup;\n    Object.keys(groups).forEach(function (groupKey) {\n      if (groups[groupKey].name === undefined) {\n        xcodeProject.addToPbxGroup(pbxGroup.uuid, groupKey);\n      }\n    });\n\n    // WORK AROUND for xcodeProject.addTarget BUG\n    const projObjects = xcodeProject.hash.project.objects;\n    projObjects[\"PBXTargetDependency\"] = projObjects[\"PBXTargetDependency\"] || {};\n    projObjects[\"PBXContainerItemProxy\"] = projObjects[\"PBXContainerItemProxy\"] || {};\n\n    // Add widget target\n    const widgetTarget = xcodeProject.addTarget(\n      EXTENSION_TARGET_NAME,\n      \"app_extension\",\n      EXTENSION_TARGET_NAME,\n      widgetBundleId,\n    );\n\n    // Add build phases for widget\n    xcodeProject.addBuildPhase(\n      [\"widget.swift\", \"SharedDataManager.swift\", \"TaskIntents.swift\"],\n      \"PBXSourcesBuildPhase\",\n      \"Sources\",\n      widgetTarget.uuid,\n      undefined,\n      \"widget\",\n    );\n    \n    xcodeProject.addBuildPhase(\n      [\"SwiftUI.framework\", \"WidgetKit.framework\", \"ActivityKit.framework\"],\n      \"PBXFrameworksBuildPhase\", \n      \"Frameworks\",\n      widgetTarget.uuid,\n    );\n    \n    xcodeProject.addBuildPhase(\n      [\"Assets.xcassets\"],\n      \"PBXResourcesBuildPhase\",\n      \"Resources\",\n      widgetTarget.uuid,\n      undefined,\n      \"widget\",\n    );\n\n    // Update build configurations\n    const configurations = xcodeProject.pbxXCBuildConfigurationSection();\n    for (const key in configurations) {\n      if (typeof configurations[key].buildSettings !== \"undefined\") {\n        const productName = configurations[key].buildSettings.PRODUCT_NAME;\n        if (productName === `\"${EXTENSION_TARGET_NAME}\"`) {\n          const buildSettings = {\n            ...configurations[key].buildSettings,\n            ...BUILD_CONFIGURATION_SETTINGS,\n            PRODUCT_BUNDLE_IDENTIFIER: widgetBundleId,\n            DEVELOPMENT_TEAM: developmentTeamId,\n            LD_RUNPATH_SEARCH_PATHS: `\"$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks\"`,\n            IPHONEOS_DEPLOYMENT_TARGET: \"16.2\",\n          };\n          configurations[key].buildSettings = buildSettings;\n        }\n      }\n    }\n\n    // Add ActivityKit framework to main app target\n    const targets = xcodeProject.hash.project.objects.PBXNativeTarget;\n    for (const targetKey in targets) {\n      if (targets[targetKey].name && targets[targetKey].name.indexOf('quot') === -1) {\n        const targetName = targets[targetKey].name.replace(/\"/g, '');\n        if (targetName === xcodeProject.productName) {\n          // Add ActivityKit framework to main app\n          xcodeProject.addFramework('ActivityKit.framework', {\n            target: targetKey,\n            link: true\n          });\n        }\n      }\n    }\n\n    // Write the updated project file\n    fs.writeFileSync(projPath, xcodeProject.writeSync());\n  });\n}"]}